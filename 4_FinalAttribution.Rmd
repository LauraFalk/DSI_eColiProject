---
title: "4_FinalAttribution"
author: "Laura Palacios"
date: '2022-09-08'
output: html_document
---

```{r setup, include=FALSE}
library(corrplot)
library(knitr)
library(lubridate)
library(tidyverse)
library(zoo)
opts_chunk$set(echo = TRUE)
```

This is going to be for attributing to the processed e coli data:
1. flow or water pulses
2. air temperature
3. season (Monsoon, Fall, Winter, Summer - USE SODN criteria)
4. possibly precip data: options - rainfall in last month, rainfall in last year, time since last rainfall
5. possibly location - miles from the Nogales plant
6. what else?


First step. Merge the ecoli data with the USGS (flow) data.
```{r}
ecoli_ForAttribution$DateTime2 <- as.POSIXct(format(paste(ecoli_ForAttribution$DateAsDate,ecoli_ForAttribution$ActivityStartTime.Time), format = '%Y-%m-%d %H:%M'), tz = tz)

ecoli_ForAttribution$DateTime2 <-
round_date(as.POSIXct(ecoli_ForAttribution$DateTime2), "15 minutes")


Storet_USGS_Merge<- left_join(ecoli_ForAttribution, 
                          USGS_ForAnalysis2, by = c("DateTime2"))

Storet_USGS_Merge %>%
  count(is.na(Discharge_CFS))
# 75 records are still without discharge. this is the one I care the most about.
```


Remove the nulls from the merge. This is performed here rather than by using a sided join so that I may decide to do something different later on.
```{r}
Storet_USGS_Merge_NoNull <- Storet_USGS_Merge %>%
  filter(!is.na(Discharge_CFS))
  
```


Look at what the data currently looks like. The red line is the actual standard for warm water effluent in AZ. The blue dotted line indicates the state standard for an average of three+ measurements. It is not technically applicable here, but gives a baseline. It may  be used to flag "Concerning-but-not-technically-bad" levels of E. coli.
```{r}
Storet_USGS_Merge_NoNull %>%
  ggplot(aes(x=Discharge_CFS, y=StandardizedResult)) +
  geom_point()+
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2)+
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```

Now I want to see what it looks like without the outlying discharge values.
```{r}
Storet_USGS_Merge_NoNull %>%
  filter(Discharge_CFS < 250) %>%
  ggplot(aes(x=Discharge_CFS, y=StandardizedResult)) +
  geom_point() +
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2) +
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```
Now I want to see what it looks like without the outlying discharge values. And one more for good measure.
```{r}
Storet_USGS_Merge_NoNull %>%
  filter(Discharge_CFS < 150) %>%
  ggplot(aes(x=Discharge_CFS, y=StandardizedResult)) +
  geom_point() +
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2) +
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```
well, it definitely doesn't look randomly distributed.


Let's add some air temperature up in here up in here.
```{r}
DailyClimate <- read.csv("Data/Raw/ClimateAnalyzer_DailySummaryStats.csv", skip = 3)
DailyClimate <- head(DailyClimate, - 1)
```

What about the sum of previous three-days precipitation
LAURA YOURE HERE
```{r}
DailyClimate$Previous3Precip <-  rollsumr(DailyClimate$Precipitation..in., k = 3, fill = NA)
DailyClimate$Previous7Precip <-  rollsumr(DailyClimate$Precipitation..in., k = 7, fill = NA)
DailyClimate$Previous30Precip <-  rollsumr(DailyClimate$Precipitation..in., k = 30, fill = NA)
```


```{r}
DailyClimate$DateAsDate <- str_sub(DailyClimate$Date,-10,-1)
DailyClimate$DateAsDate <-as.POSIXct(DailyClimate$DateAsDate, format = "%m/%d/%Y", tz = tz)
```

merge together with other data
```{r}
Storet_USGS_Merge_NoNull$DateAsDate <-as.POSIXct(Storet_USGS_Merge_NoNull$DateAsDate, format = "%Y-%m-%d", tz = tz)


Storet_USGS_Climate_Merge<- left_join(Storet_USGS_Merge_NoNull, 
                          DailyClimate, by = c("DateAsDate"))



Storet_USGS_Climate_Merge %>%
  filter(is.nan(Tmax..F.))
# we have 113 more missing Tmax datapoints. I could possibly manipulate this file to clean nans but I'm not sure how comfortable I feel about this. LAURA check in on this with expert.
```

Graph again

```{r}
Storet_USGS_Climate_Merge %>%
  filter(!is.nan(Tmax..F.)) %>%
  ggplot(aes(x=Tmax..F., y=StandardizedResult)) +
  geom_point() +
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2) +
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```
This isn't as great as I thought it would be. 
Google says temps of 39-113°F are survivable for e. coli. ideal is 98.6°F.


```{r}
Storet_USGS_Climate_Merge %>%
  filter(!is.nan(Tmin..F.)) %>%
  ggplot(aes(x=Tmin..F., y=StandardizedResult)) +
  geom_point() +
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2) +
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```
It is of note that the max only happens above freezing. This may actually be more meaningful.

There is probably a better source for precip, but I'd like to take a look at it. It may be correlated to flow. I'll have to check this later.
```{r}
Storet_USGS_Climate_Merge %>%
  filter(!is.nan(Precipitation..in.)) %>%
  ggplot(aes(x=Precipitation..in., y=StandardizedResult)) +
  geom_point() +
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2) +
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```
Now I want to look at season. According to the NPS protocol the seasons in southern Arizona are:
Fall (October 1 - December 30)
Winter (January 1 - March 30)
Spring (April 1 - June 30)
Monsoon (July 1 - Sept 30)

```{r}
Storet_USGS_Climate_Merge$Season1 <- as.numeric(str_sub(Storet_USGS_Climate_Merge$DateAsDate,6,7))
  
  
Storet_USGS_Climate_Merge$Season <- ifelse(Storet_USGS_Climate_Merge$Season1 > 9 & Storet_USGS_Climate_Merge$Season1 < 13, "Fall", 
                                           ifelse (Storet_USGS_Climate_Merge$Season1 > 0 & Storet_USGS_Climate_Merge$Season1 < 4, "Winter",
                                                   ifelse (Storet_USGS_Climate_Merge$Season1 > 3 & Storet_USGS_Climate_Merge$Season1 < 7, 
                                    "Spring", "Monsoon")))
```


The columns are getting messy. Remove duplicates and nulls
```{r}
Storet_USGS_Climate_Merge <-Storet_USGS_Climate_Merge %>%
  select(-DateTime, -X.x, -agency_cd, -site_no, -dateTime, -Date, -X.y, -Season1)
```


```{r}
Storet_USGS_Climate_Merge %>%
  ggplot(aes(x=Season, y=StandardizedResult)) +
  geom_point() +
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2) +
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```
Notes on above diagram: Monsoon values seem significantly above blue line. Winter values have many less maximum values.



graph this too.
```{r}
Storet_USGS_Climate_Merge %>%
  ggplot() +
  geom_point(aes(x=Previous3Precip, y=StandardizedResult), color = "red") +
  geom_point(aes(x=Previous7Precip, y=StandardizedResult), color = "blue")+
  geom_point(aes(x=Previous30Precip, y=StandardizedResult), color = "green")+
  geom_hline(yintercept=126, linetype="dashed", 
                color = "blue", size=0.2) +
  geom_hline(yintercept=235, linetype="dashed", 
                color = "red", size=0.2)
```

I should change the categorical variables to numeric for corrplot. After changing them to text. oops. 
Numerical Categorical
```{r}
Storet_USGS_Climate_Merge$SeasonNumeric <- ifelse(Storet_USGS_Climate_Merge$Season == "Fall", 1,
                                                  ifelse(Storet_USGS_Climate_Merge$Season == "Winter", 2,
                                                  ifelse (Storet_USGS_Climate_Merge$Season =="Spring", 3,4)))
```

Lets try corrplot
```{r}
ForCorrplot <- Storet_USGS_Climate_Merge %>%
  select(StandardizedResult, Discharge_CFS, Precipitation..in., Tmax..F., Tmin..F., PreviousPrecip, Previous3Precip, Previous7Precip, Previous30Precip, SeasonNumeric)

sapply(ForCorrplot, class) # Ensure these are all numeric


ForCorrplot <- 
```

